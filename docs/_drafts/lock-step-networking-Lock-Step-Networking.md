---
id: 1368
title: 'Lock Step Networking'
date: '2015-04-15T09:19:27+08:00'
author: Jimmy
layout: post
guid: 'http://www.ownself.org/blog/?p=1368'
permalink: '/?p=1368'
categories:
    - 未分类
---

# 前言

在早期游戏的网络对战实现方式上，有这个两个经典的例子，对后世的游戏影响极深，一个是《雷神之锤》，采用的是基于状态的同步，每个客户端上的数据并不具有权威性也不具有完整性，只有自己角色的完整信息，每过固定时间与服务器进行同步更新游戏世界中其他物体包括和自己有关系的其他玩家的状态：位置、血量、速度等等，而服务器拥有世界中所有物品的权威信息，负责接收玩家的状态更新申请并验证后进行世界更新的计算然后将计算后的结果发送给每个客户端，当客户端和服务器之间的数据发生不同步时，以服务器的数据为权威，这种模式非常适合游戏世界中活动物体较为有限但比较强调操作需要即时反馈的FPS游戏，目前最新的Unreal虚幻4引擎依然延续着这种经典的网络同步模式；另一个就是帝国时代，采用的则是基于指令的同步，每个客户端都拥有相同的完整的数据，每过固定时间每个客户端将自己的输入或指令发给服务器，服务器收集齐数据后再统一发给所有客户端，每个客户端收到数据后根据这些输入或指令各自在本地模拟计算游戏状态，这种方式可以在很小的带宽消耗下实现庞大物体数量的游戏世界的网络对战，但是以一定的操控延迟为牺牲代价的，另外保证每个客户端模拟结果的一致性是一个非常大的挑战，而大多数的RTS都是采用这种机制来实现网络对战，即使是目前最新的《星际争霸2》，今天我们就来介绍一下这种叫做Lock-Step的网络同步实现。

# 设计目的

之所以RTS类的游戏无法使用状态同步模式的最重要的原因是，RTS中一个玩家所能拥有的单位数量过于庞大，在《星际争霸》中，即使游戏为每个玩家限定了最多200单位的人口上限，但是考虑8位玩家同时对战的情况，最糟的可能游戏还是需要同步接近2000个单位的状态；即时我们将单位数量限制在网络刚刚可以应付的情况下，这种随着单位数量增长而联机质量下降的体验相信也绝对不是一个合理的选择。在早先《帝国时代》和《星际争霸》的那个56Kb拨号时代，依然可以实现8位玩家同屏数千单位的流畅对战，可见Lock-Step确实是这类游戏的不二选择。

# 实现

Lock-Step的核心实现相较于状态同步，最大的不同点还是在于各个客户端之间同步的并非是游戏中单位的状态，而是玩家的操作指令，而且在Lock-step中服务器并没有数据的权威性，在基于状态的同步模型中是假设客户端与服务器之间总是不同步的，需要不停的通过服务器上的具有权威性的数据来修正客户端的数据，就是为什么我们在网络糟糕的情况下玩《Counter-Strike》时，玩家走起路来会感觉飘和瞬移；而在Lock-step中，服务器的最重要的责任仅仅是确保所有的操作指令准确的发送给每一位玩家，然后各个客户端再以精准的次序执行所有个操作指令以达到每个客户端上执行操作后的结果一模一样的效果。

说起来容易，但是我们知道网络的延迟是无可避免的，而更糟糕的是延迟时长又是无法预知的……这时候我们就需要Lock-step中最重要的一个机制——帧同步机制：

帧同步

既然网络的延迟是确定的，我们又需要确保所有玩家收到的操作指令都是正确并且有序的，那么我们就

头疼的Out of Sync

Pros and Cons

改进